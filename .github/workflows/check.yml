name: Check/test

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited
    branches:
      - master
  push:
    branches:
      - master

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  release:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: "true"

      - name: Fetch full history
        run: git fetch --unshallow

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: yarn

      - name: Run install
        uses: borales/actions-yarn@v4
        with:
          cmd: install --frozen-lockfile

      - name: Run compile
        uses: borales/actions-yarn@v4
        with:
          cmd: compile:prod

      - name: Run changelog
        uses: borales/actions-yarn@v4
        with:
          cmd: changelog

      - name: Show changelog.md
        run: cat CHANGELOG.md

      - name: Test artifacts
        shell: pwsh
        run: |
          $files = @("changelog.html", "render.js", "preload.js", "main.js")
          $dir = "build"
          $files | ForEach-Object {
            if (-not (Test-Path "$dir\$_")) {
              Write-Error "File $_ not found in $dir"
              exit 1
            }
            $size = (Get-Item "$dir\$_").Length
            Write-Host "File $_ found in $dir, size: $size bytes"
          }
